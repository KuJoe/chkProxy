Proxy/VPN Detection Hook for WHMCS by KuJoe (JMD.cc)

1.1 -	Fixed bug that caused duplicate lookups to MaxMind.
1.2 -	Fixed bug that caused client account to be registered even if order was blocked.
		Replaced redirect with error message on the shopping cart.
		Removed template files.
1.3 -	Fixed version number typo.
		Better formatting and comments for non-code savvy users.
		Updated instructions.
1.4 -	Added database table to conserve MaxMind queries and for reviewing scores.
		Created a WHMCS report for the last 50 proxy check scores.
1.5 -	Fixed script to only write to the database once per IP address.
		Script generates e-mail alerts when the MaxMind lookup returns something other than a numeric score.
		Added database field that allows ignoring IPs that fail VPN checks.
1.6 -	Fixed the ignore IP option.
		Fixed e-mail alerts.
		IPs can be ignored/unignored in the Last 50 Proxy Checks report.
1.7 -	Limited Last 50 Proxy Checks report to 50. (Doh!)
	
//Requirements:
You need to purchase Proxy Detection queries from MaxMind (the free minFraud queries will NOT work). http://www.maxmind.com/en/proxy

//Installation/Upgrade:
1) Set $license_key and $email in chkProxy.php.
2) Create mod_chkproxy table in WHMCS database (query below).
3) Upload the chkProxy.php file into your WHMCS's hooks directory (/includes/hooks/).
4) Upload the last_50_proxy_checks.php file into your WHMCS's reports directory (/modules/reports/).
5) Run this query to create the database table (run this command in phpMyAdmin, Adminer, SQLBuddy, command line, or your MySQL editor of choice):

-- START QUERY
CREATE TABLE IF NOT EXISTS `mod_chkproxy` (
	  `chkid` int(11) NOT NULL AUTO_INCREMENT,
	  `ipaddr` varchar(40) NOT NULL,
	  `proxyscore` varchar(4) NOT NULL,
	  `ignore` int(1) NOT NULL DEFAULT '0',
	  `dt` TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
	  PRIMARY KEY (`chkid`)
);
-- END QUERY

//Optional:
A) Edit $max_score to fine tune detection (lower means will block more proxies but also have a higher change of blocking legit clients also). SEE ADDITIONAL INFORMATION.
B) Edit $error to fit your needs and match your template. To test your error message without access to a proxy/VPN, just set the $max_score to 0.00 to force the message to trigger (no orders will be processed until this is changed back).

//Additional Information:
A $max_score of 1.7-1.8 is recommended. I've found that many large data centers return a score of 1.8 and every US residential ISP that I've tested has been a 0.00 so you can adjust accordingly. If you want to find the score of a specific IP address use the following URL in your browser:
https://minfraud.maxmind.com/app/ipauth_http?l=YOURLICENCEKEY&i=IPADDRESS

If your website is behind a reverse proxy (i.e. CloudFlare) this hook might not work. You will need to configure your webserver to display the correct IP address of visitors.

If you have a lot of duplicate entries in the mod_chkproxy table (fixed in version 1.5), run the following MySQL query to remove the duplicates:

-- START QUERY
DELETE n1 FROM mod_chkproxy n1, mod_chkproxy n2 WHERE n1.chkid < n2.chkid AND n1.ipaddr = n2.ipaddr;
-- END QUERY